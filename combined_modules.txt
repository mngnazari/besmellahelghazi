

==================================================
# ÙØ§ÛŒÙ„: database.py
==================================================


import sqlite3
from datetime import datetime, timedelta
import secrets
import string

from telegram import ReplyKeyboardMarkup

import logging
logger = logging.getLogger(__name__)


# Ø¢ÛŒ Ø¯ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§ØµÙ„ÛŒ
ADMIN_ID = 2138687434


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
# ----------------------
def generate_referral_code(length=8):
    """ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø±ÙØ±Ø§Ù„ ØªØµØ§Ø¯ÙÛŒ"""
    chars = string.ascii_uppercase + string.digits
    return ''.join(secrets.choice(chars) for _ in range(length))


# ----------------------
# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„
# ----------------------
def create_tables():
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()

    c.execute('''CREATE TABLE IF NOT EXISTS files
                 (
                     id INTEGER PRIMARY KEY AUTOINCREMENT,
                     user_id INTEGER,
                     file_name TEXT,
                     mime_type TEXT,
                     file_id TEXT UNIQUE,
                     file_unique_id TEXT,
                     created_at TEXT,
                     quantity INTEGER,
                     description TEXT,
                     status TEXT DEFAULT 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…',
                     notes TEXT
                 )''')  # Ø­Ø°Ù Ú©Ø§Ù…Ù†Øª ÙØ§Ø±Ø³ÛŒ Ø§Ø² Ø¯Ø§Ø®Ù„ Ø¯Ø³ØªÙˆØ± SQL



    # Ø¬Ø¯ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    c.execute('''CREATE TABLE IF NOT EXISTS users
                 (
                     id INTEGER PRIMARY KEY,
                     full_name TEXT,
                     phone TEXT UNIQUE,
                     inviter_id INTEGER,
                     remaining_invites INTEGER DEFAULT 1,
                     created_at TEXT,
                     updated_at TEXT
                 )''')

    # Ø¬Ø¯ÙˆÙ„ Ø±ÙØ±Ø§Ù„â€ŒÙ‡Ø§
    c.execute('''CREATE TABLE IF NOT EXISTS referrals
                 (
                     id INTEGER PRIMARY KEY AUTOINCREMENT,
                     referrer_id INTEGER,
                     referral_code TEXT UNIQUE,
                     used_by INTEGER DEFAULT NULL,
                     created_at TEXT,
                     expires_at TEXT,
                     is_admin BOOLEAN DEFAULT FALSE,
                     FOREIGN KEY(referrer_id) REFERENCES users(id)
                 )''')

    # Ø¬Ø¯ÙˆÙ„ Ù…Ø¯Ø¹ÙˆÛŒÙ†
    c.execute('''CREATE TABLE IF NOT EXISTS invited_users
                 (
                     referrer_id INTEGER,
                     invited_user_id INTEGER PRIMARY KEY,
                     invited_full_name TEXT,
                     invited_phone TEXT,
                     invited_at TEXT,
                     FOREIGN KEY(referrer_id) REFERENCES users(id),
                     FOREIGN KEY(invited_user_id) REFERENCES users(id)
                 )''')

    # Ø¬Ø¯ÙˆÙ„ Ú©ÛŒÙ Ù¾ÙˆÙ„
    c.execute('''CREATE TABLE IF NOT EXISTS wallets
                 (
                     user_id INTEGER PRIMARY KEY,
                     balance REAL DEFAULT 0,
                     discount REAL DEFAULT 0,
                     FOREIGN KEY(user_id) REFERENCES users(id)
                 )''')

    conn.commit()
    conn.close()


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
# ----------------------
def add_user(user_data):
    """Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡"""
    conn = None
    try:
        conn = sqlite3.connect('print3d.db')
        c = conn.cursor()

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† ØªÚ©Ø±Ø§Ø±ÛŒ
        c.execute("SELECT id FROM users WHERE phone = ?", (user_data[2],))
        if c.fetchone():
            raise sqlite3.IntegrityError("Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† ØªÚ©Ø±Ø§Ø±ÛŒ")

        # Ø¯Ø±Ø¬ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
        c.execute('''INSERT INTO users 
                    (id, full_name, phone, inviter_id, created_at, updated_at)
                    VALUES (?, ?, ?, ?, ?, ?)''', user_data)

        # Ø§ÛŒØ¬Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯ Ú©ÛŒÙ Ù¾ÙˆÙ„
        c.execute('''INSERT INTO wallets (user_id, balance, discount)
                    VALUES (?, 0, 0)''', (user_data[0],))

        conn.commit()
        return True

    except sqlite3.IntegrityError as e:
        print(f"â—Ø®Ø·Ø§ÛŒ ÛŒÚ©ØªØ§ÛŒÛŒ: {str(e)}")
        raise  # Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø®Ø·Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø± Ù„Ø§ÛŒÙ‡ Ø¨Ø§Ù„Ø§ØªØ±
    except Exception as e:
        print(f"ğŸ”¥ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±: {str(e)}")
        if conn:
            conn.rollback()
        return False
    finally:
        if conn:
            conn.close()


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ø±ÙØ±Ø§Ù„
# ----------------------
def create_referral(user_id, is_admin=False):
    """Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø¯ Ø¯Ø¹ÙˆØª Ø¬Ø¯ÛŒØ¯"""
    conn = None
    try:
        conn = sqlite3.connect('print3d.db')
        c = conn.cursor()

        # Ø¨Ø±Ø±Ø³ÛŒ Ø¸Ø±ÙÛŒØª Ø¯Ø¹ÙˆØª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ
        if not is_admin:
            c.execute("SELECT remaining_invites FROM users WHERE id = ?", (user_id,))
            remaining = c.fetchone()[0]
            if remaining <= 0:
                return None, "Ø¸Ø±ÙÛŒØª Ø¯Ø¹ÙˆØª Ø´Ù…Ø§ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª"

        # ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø±ÙØ±Ø§Ù„
        code = generate_referral_code()

        # ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ (Û± Ø³Ø§Ù„)
        expires = (datetime.now() + timedelta(days=365)).strftime("%Y-%m-%d %H:%M:%S")

        # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        c.execute('''INSERT INTO referrals 
                    (referrer_id, referral_code, created_at, expires_at, is_admin)
                    VALUES (?, ?, ?, ?, ?)''',
                  (user_id, code, datetime.now().strftime("%Y-%m-%d %H:%M:%S"), expires, is_admin))

        conn.commit()
        return code, None

    except sqlite3.IntegrityError:
        return None, "Ú©Ø¯ Ø¯Ø¹ÙˆØª ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."
    except Exception as e:
        print(f"ğŸ”¥ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø¯ Ø¯Ø¹ÙˆØª: {str(e)}")
        return None, "Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ"
    finally:
        if conn:
            conn.close()


def validate_referral(code):
    try:
        conn = sqlite3.connect('print3d.db')
        c = conn.cursor()

        c.execute('''SELECT referrer_id, expires_at 
                     FROM referrals 
                     WHERE referral_code = ? 
                     AND used_by IS NULL
                     AND expires_at > CURRENT_TIMESTAMP''',
                  (code,))

        result = c.fetchone()
        if not result:
            return False, "Ú©Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª"

        referrer_id, expires_at = result
        return True, referrer_id

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ: {str(e)}")
        return False, "Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ"
    finally:
        conn.close()


def add_invited_user(referrer_id, user_data):
    try:
        conn = sqlite3.connect('print3d.db')
        c = conn.cursor()
        c.execute('''INSERT INTO invited_users 
                     (referrer_id, invited_user_id, invited_full_name, invited_phone, invited_at)
                     VALUES (?, ?, ?, ?, ?)''',
                  (referrer_id, *user_data))
        conn.commit()
        return True
    except Exception as e:
        print(f"Error adding invited user: {str(e)}")
        return False
    finally:
        conn.close()




def mark_referral_used(code, used_by):
    """Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ú©Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡"""
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute("UPDATE referrals SET used_by = ? WHERE referral_code = ?", (used_by, code))
    conn.commit()
    conn.close()


# ----------------------
# ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯Ø¹ÙˆÛŒÙ†
# ----------------------
def add_invited_user(referrer_id, user_data):
    """Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¯Ø¹Ùˆ"""
    try:
        conn = sqlite3.connect('print3d.db')
        c = conn.cursor()
        c.execute('''INSERT INTO invited_users 
                     (referrer_id, invited_user_id, invited_full_name, invited_phone, invited_at)
                     VALUES (?, ?, ?, ?, ?)''',
                  (referrer_id, *user_data))
        conn.commit()
        return True
    except Exception as e:
        print(f"Error adding invited user: {str(e)}")
        return False
    finally:
        conn.close()


def get_invited_users(referrer_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù…Ø¯Ø¹ÙˆÛŒÙ†"""
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute('''SELECT invited_full_name, invited_phone, invited_at 
                 FROM invited_users 
                 WHERE referrer_id = ?''', (referrer_id,))
    return c.fetchall()

def decrement_invites(user_id):
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute("UPDATE users SET remaining_invites = remaining_invites - 1 WHERE id = ?", (user_id,))
    conn.commit()
    conn.close()

def get_user(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù†Ø§Ø³Ù‡"""
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute("SELECT * FROM users WHERE id = ?", (user_id,))
    result = c.fetchone()
    conn.close()
    return result

def get_active_orders(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª ÙØ¹Ø§Ù„ Ú©Ø§Ø±Ø¨Ø±"""
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute("""
        SELECT * FROM files 
        WHERE user_id = ? 
        AND status = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…'
        ORDER BY created_at DESC
    """, (user_id,))
    results = c.fetchall()
    conn.close()
    return results

def get_active_orders_count(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª ÙØ¹Ø§Ù„"""
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute("""
        SELECT COUNT(*) FROM files 
        WHERE user_id = ? 
        AND status = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…'
    """, (user_id,))
    result = c.fetchone()
    conn.close()
    return result[0] if result else 0


def add_file(file_data):
    """Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³"""
    try:
        conn = sqlite3.connect('print3d.db')
        c = conn.cursor()

        c.execute('''INSERT INTO files 
                    (user_id, file_name, mime_type, file_id, file_unique_id, 
                     created_at, quantity, description, status, notes)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)''',
                  file_data)
        conn.commit()
        return True
    except sqlite3.IntegrityError as e:
        print(f"Ø®Ø·Ø§ÛŒ ÛŒÚ©ØªØ§ÛŒÛŒ: {str(e)}")
        return False
    except Exception as e:
        print(f"Ø®Ø·Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„: {str(e)}")
        return False
    finally:
        conn.close()

def get_files_by_user(user_id, days=None):
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()

    query = "SELECT * FROM files WHERE user_id = ?"
    params = [user_id]

    if days:
        date_filter = (datetime.now() - timedelta(days=days)).strftime("%Y-%m-%d %H:%M:%S")
        query += " AND created_at >= ?"
        params.append(date_filter)

    c.execute(query, params)
    results = c.fetchall()
    conn.close()
    return results


def update_file_description(file_id, description):
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    try:
        c.execute("UPDATE files SET description = ? WHERE file_id = ?",
                 (description, file_id))
        conn.commit()
        return True
    except Exception as e:
        print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª ØªÙˆØ¶ÛŒØ­Ø§Øª: {str(e)}")
        return False
    finally:
        conn.close()

def get_file_quantity(file_id):
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute("SELECT quantity FROM files WHERE file_id = ?", (file_id,))
    result = c.fetchone()
    conn.close()
    return result[0] if result else 1

def update_file_quantity(file_id, new_qty):
    print(f"Updated quantity for file {file_id} to {new_qty}")
    try:
        conn = sqlite3.connect('print3d.db')
        c = conn.cursor()
        c.execute("UPDATE files SET quantity = ? WHERE file_id = ?", (new_qty, file_id))
        conn.commit()
        return True
    except Exception as e:
        print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯: {str(e)}")
        return False
    finally:
        conn.close()

def delete_file(file_id):
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute("DELETE FROM files WHERE file_id = ?", (file_id,))
    conn.commit()
    conn.close()

def get_remaining_invites(user_id):
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute("SELECT remaining_invites FROM users WHERE id = ?", (user_id,))
    result = c.fetchone()
    conn.close()
    return result[0] if result else 0


def add_discount(user_id, amount):
    try:
        conn = sqlite3.connect('print3d.db')
        c = conn.cursor()

        c.execute("""
            UPDATE wallets 
            SET discount = discount + ? 
            WHERE user_id = ?
        """, (amount, user_id))

        conn.commit()
        return c.rowcount > 0

    except Exception as e:
        print(f"Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† ØªØ®ÙÛŒÙ: {str(e)}")
        return False
    finally:
        conn.close()


# Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ø­ÙØ¸ Ú©Ø±Ø¯Ù‡ Ùˆ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯
def get_customer_kb(user_id):
    """ØªÙ‡ÛŒÙ‡ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±ÛŒ Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª ÙØ¹Ø§Ù„"""
    from keyboards import ReplyKeyboardMarkup  # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ…Ù¾ÙˆØ±Øª

    active_orders = get_active_orders_count(user_id)

    return ReplyKeyboardMarkup(
        keyboard=[
            ["ğŸ“‚ Ø¢Ø±Ø´ÛŒÙˆ", f"ğŸ”„ Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… ({active_orders})"],
            ["ğŸ’³ Ú©ÛŒÙ Ù¾ÙˆÙ„", "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"],
            ["ğŸ“œ Ù‚ÙˆØ§Ù†ÛŒÙ†", "ğŸ§¾ ÙØ§Ú©ØªÙˆØ±"],
            ["ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡"]
        ],
        resize_keyboard=True,
        is_persistent=True
    )

# Ø¯Ø± ÙØ§ÛŒÙ„ database.py Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯

def meets_gift_conditions(user_id):
    try:
        conn = sqlite3.connect('print3d.db')
        c = conn.cursor()

        # Ù…Ø«Ø§Ù„: Ø­Ø¯Ø§Ù‚Ù„ Û³ Ø³ÙØ§Ø±Ø´ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡
        c.execute("""
            SELECT COUNT(*) FROM files 
            WHERE user_id = ? 
            AND status = 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡'
        """, (user_id,))

        result = c.fetchone()
        return result[0] >= 3 if result else False

    except Exception as e:
        print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ· Ù‡Ø¯ÛŒÙ‡: {str(e)}")
        return False
    finally:
        conn.close()

def get_completed_orders(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡"""
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()
    c.execute("""
        SELECT * FROM files 
        WHERE user_id = ? 
        AND status = 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡'
    """, (user_id,))
    results = c.fetchall()
    conn.close()
    return results


def get_referral_tree(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡"""
    conn = sqlite3.connect('print3d.db')
    conn.row_factory = sqlite3.Row
    c = conn.cursor()

    try:
        print(f"\nğŸ” Ø´Ø±ÙˆØ¹ Ú©ÙˆØ¦Ø±ÛŒ Ø¨Ø±Ø§ÛŒ user_id: {user_id}")

        c.execute('''
            WITH RECURSIVE referral_tree AS (
                SELECT 
                    id,
                    full_name,
                    phone,
                    inviter_id,
                    0 AS level
                FROM users
                WHERE id = ?

                UNION ALL

                SELECT 
                    u.id,
                    u.full_name,
                    u.phone,
                    u.inviter_id,
                    rt.level + 1
                FROM users u
                INNER JOIN referral_tree rt ON u.inviter_id = rt.id
            )
            SELECT * FROM referral_tree
        ''', (user_id,))

        results = c.fetchall()
        print(f"âœ… ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù‡: {len(results)}")
        for idx, row in enumerate(results):
            print(f"   {idx + 1}. {dict(row)}")

        return [dict(row) for row in results]

    except Exception as e:
        print(f"ğŸ”¥ Ø®Ø·Ø§: {str(e)}")
        return []
    finally:
        conn.close()


def format_referral_tree(tree_data):
    """Ù‚Ø§Ù„Ø¨â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø±Ø®Øª Ø¨Ø§ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ ØªØ´Ø®ÛŒØµÛŒ"""
    if not tree_data:
        print("âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!")
        return "Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"

    print("\nğŸ” Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø±Ø®Øª:")
    print("Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù…:", tree_data)

    try:
        # Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ
        tree = {}
        for item in tree_data:
            inviter_id = item['inviter_id']
            if inviter_id not in tree:
                tree[inviter_id] = []
            tree[inviter_id].append(item)
            print(f"   Ø§ÙØ²ÙˆØ¯Ù†: {item['full_name']} (inviter: {inviter_id})")

        print("\nØ³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡:", tree)

        # ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ
        def build_branch(parent_id, level=0):
            branch = []
            for child in tree.get(parent_id, []):
                prefix = "    " * level + "â””â”€â”€ " if level > 0 else ""
                entry = f"{prefix}ğŸ‘¤ {child['full_name']} ({child['phone']})"
                print(f"Ø³Ø§Ø®Øª Ø´Ø§Ø®Ù‡: {entry}")
                branch.append(entry)
                branch.extend(build_branch(child['id'], level + 1))
            return branch

        final_output = "\n".join(build_branch(None))
        print("\nØ®Ø±ÙˆØ¬ÛŒ Ù†Ù‡Ø§ÛŒÛŒ:\n", final_output)
        return final_output

    except Exception as e:
        print(f"ğŸ”¥ Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ: {str(e)}")
        return "Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®ØªØ§Ø±"


# database.py
def get_direct_invites(user_id):
    """Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ù…Ø¯Ø¹ÙˆÛŒÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ú©Ø§Ø±Ø¨Ø±"""
    conn = sqlite3.connect('print3d.db')
    c = conn.cursor()

    try:
        c.execute('''
            SELECT invited_full_name, invited_phone, invited_at 
            FROM invited_users 
            WHERE referrer_id = ?
            ORDER BY invited_at DESC
        ''', (user_id,))

        return c.fetchall()

    except Exception as e:
        print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¯Ø¹ÙˆÛŒÙ† Ù…Ø³ØªÙ‚ÛŒÙ…: {str(e)}")
        return []
    finally:
        conn.close()

==================================================
# ÙØ§ÛŒÙ„: keyboards.py
==================================================

from telegram import (
    ReplyKeyboardMarkup,
    KeyboardButton,
    InlineKeyboardButton,
    InlineKeyboardMarkup
)

import database

# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù¾Ø§ÛŒÙ‡ Ø¨Ø¯ÙˆÙ† Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯
customer_kb = ReplyKeyboardMarkup(
    [
        ["ğŸ“‚ Ø¢Ø±Ø´ÛŒÙˆ", "ğŸ”„ Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…"],
        ["ğŸ’³ Ú©ÛŒÙ Ù¾ÙˆÙ„", "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"],
        ["ğŸ“œ Ù‚ÙˆØ§Ù†ÛŒÙ†", "ğŸ§¾ ÙØ§Ú©ØªÙˆØ±"],
        ["ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡"]
    ],
    resize_keyboard=True,
    is_persistent=True
)

archive_reply_kb = ReplyKeyboardMarkup(
    [
        ["ğŸ•’ Ù‡ÙØªÙ‡ Ø§Ø®ÛŒØ±", "ğŸ“… Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±"],
        ["ğŸ“‚ Ú©Ù„ Ø¢Ø±Ø´ÛŒÙˆ", "ğŸ”™ Ø¨Ø±Ú¯Ø´Øª"]
    ],
    resize_keyboard=True,
    is_persistent=True
)

# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
admin_kb = ReplyKeyboardMarkup(
    [
        ["ğŸ”— ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯"],
        ["ğŸ‘¥ Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù†", "ğŸ“Š Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…"],
        ["ğŸŒ³ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®Øª Ø¯Ø¹ÙˆØª"]  # Ø¯Ú©Ù…Ù‡ Ø¬Ø¯ÛŒØ¯
    ],
    resize_keyboard=True
)

def get_qty_keyboard(current_qty=1):
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("-", callback_data="qty_down"),
            InlineKeyboardButton(str(current_qty), callback_data="noop"),
            InlineKeyboardButton("+", callback_data="qty_up")
        ],
        [
            InlineKeyboardButton("ØªØ£ÛŒÛŒØ¯ âœ…", callback_data="qty_confirm"),
            InlineKeyboardButton("Ù„ØºÙˆ â†©ï¸", callback_data="qty_cancel")
        ]
    ])

# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ú©ÛŒÙ Ù¾ÙˆÙ„
wallet_kb = ReplyKeyboardMarkup(
    [
        ["ğŸ’µ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ", "ğŸ« Ø§Ø¹ØªØ¨Ø§Ø± ØªØ®ÙÛŒÙ"],
        ["ğŸ”™ Ø¨Ø±Ú¯Ø´Øª"]
    ],
    resize_keyboard=True
)
#
def get_customer_kb(user_id):
    active_orders = database.get_active_orders_count(user_id)
    return ReplyKeyboardMarkup(
        [
            ["ğŸ“‚ Ø¢Ø±Ø´ÛŒÙˆ", f"ğŸ”„ Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… ({active_orders})"],
            ["ğŸ’³ Ú©ÛŒÙ Ù¾ÙˆÙ„", "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"],
            ["ğŸ“œ Ù‚ÙˆØ§Ù†ÛŒÙ†", "ğŸ§¾ ÙØ§Ú©ØªÙˆØ±"],
            ["ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡"]
        ],
        resize_keyboard=True,
        is_persistent=True
    )

==================================================
# ÙØ§ÛŒÙ„: main.py
==================================================

import os
from telegram.ext import CallbackQueryHandler

from telegram.ext import (
    Application,
    CallbackQueryHandler,
    CommandHandler,
    ConversationHandler,
    MessageHandler,
    filters
)

import database

from handlers.admin_handlers import admin_generate_referral, show_referral_tree
from handlers.file_handlers import (
    handle_files,
    handle_reply,  # Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡
    handle_callback
)
from handlers.user_handlers import (
    FULL_NAME,
    PHONE,
    cancel_registration,
    get_full_name,
    get_phone,
    handle_active_orders,
    handle_archive,
    show_archive,
    start, generate_user_referral, handle_gift_request, show_direct_invites
)
import logging

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.DEBUG  # ØªØºÛŒÛŒØ± Ø¨Ù‡ DEBUG Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… Ù„Ø§Ú¯â€ŒÙ‡Ø§
)
# ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ
logging.getLogger("telegram").setLevel(logging.WARNING)
logging.getLogger("httpx").setLevel(logging.WARNING)
logging.getLogger("apscheduler").setLevel(logging.WARNING)
logging.getLogger("asyncio").setLevel(logging.WARNING)
logging.getLogger("httpcore").setLevel(logging.WARNING)

db_path = "print3d.db"  # Ø§Ú¯Ø± Ù…Ø³ÛŒØ±Ø´ ÙØ±Ù‚ Ø¯Ø§Ø±Ù‡ØŒ Ø§ØµÙ„Ø§Ø­ Ú©Ù†

if os.path.exists(db_path):
    os.remove(db_path)
    print("ğŸ“¦ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø­Ø°Ù Ø´Ø¯.")
else:
    print("â„¹ï¸ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª.")



TOKEN = "7943645778:AAEXYzDKUc2D7mWaTcLrSkH4AjlJvVq7PaU"




def main():
    database.create_tables()

    app = Application.builder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            FULL_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_full_name)],
            PHONE: [MessageHandler(filters.CONTACT | filters.TEXT & ~filters.COMMAND, get_phone)]
        },
        fallbacks=[CommandHandler("cancel", cancel_registration)],
    )

    app.add_handler(conv_handler)
    app.add_handler(MessageHandler(filters.Document.ALL, handle_files))
    app.add_handler(MessageHandler(filters.TEXT & filters.REPLY, handle_reply))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.Regex("ğŸ“‚ Ø¢Ø±Ø´ÛŒÙˆ"), show_archive))
    app.add_handler(MessageHandler(filters.Regex("^(ğŸ•’ Ù‡ÙØªÙ‡ Ø§Ø®ÛŒØ±|ğŸ“… Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±|ğŸ“‚ Ú©Ù„ Ø¢Ø±Ø´ÛŒÙˆ)$"),handle_archive))
    app.add_handler(MessageHandler(
        filters.Regex(r"^ğŸ”„ Ø¯Ø±Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…(\(\d+\))?$"),  # Ù‚Ø¨ÙˆÙ„ Ù‡Ø± Ø¯Ùˆ ÙØ±Ù…Øª Ø¨Ø§ Ùˆ Ø¨Ø¯ÙˆÙ† Ø¹Ø¯Ø¯
        handle_active_orders
    ))
    # ØªØºÛŒÛŒØ± Ù‚Ø³Ù…Øª Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø±
    app.add_handler(MessageHandler(filters.Regex("ğŸ”— ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯"), admin_generate_referral))
    app.add_handler(CallbackQueryHandler(handle_callback))  # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø±
    # Ø¨Ù‡ Ù„ÛŒØ³Øª handlers Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:

    # Ø¯Ø± Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§:
    app.add_handler(
        MessageHandler(
            filters.Regex(r"^ğŸ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡$"),  # Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø¨Ø§Ø´Ø¯
            generate_user_referral
        )
    )
    app.add_handler(MessageHandler(filters.Regex("ğŸŒ³ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®Øª Ø¯Ø¹ÙˆØª"), show_referral_tree))
    app.add_handler(MessageHandler(filters.Regex("^ğŸ‘¥ Ù…Ø¯Ø¹ÙˆÛŒÙ† Ù…Ù†$"), show_direct_invites))

    app.run_polling()


#
if __name__ == "__main__":
    main()

==================================================
# ÙØ§ÛŒÙ„: handlers\admin_handlers.py
==================================================

from telegram import Update
from telegram.ext import ContextTypes
import database


async def admin_generate_referral(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    if user.id != database.ADMIN_ID:
        return

    code, error = database.create_referral(user.id, is_admin=True)
    if error:
        await update.message.reply_text(f"âŒ {error}")
        return

    bot_username = (await context.bot.get_me()).username
    referral_link = f"https://t.me/{bot_username}?start=ref_{code}"

    await update.message.reply_text(
        f"ğŸ”— Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø§Ø¯Ù…ÛŒÙ†:\n{referral_link}\n"
        "â³ Ø§Ø¹ØªØ¨Ø§Ø±: 1 Ø³Ø§Ù„\n"
        "ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯"
    )


async def show_users_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != database.ADMIN_ID:
        return

    users = database.get_all_users()

    response = "ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:\n\n"
    for user in users:
        response += f"ğŸ†” {user[0]} - ğŸ“ {user[2]}\n"

    await update.message.reply_text(response)


async def show_referral_tree(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != database.ADMIN_ID:
        return

    try:
        tree_data = database.get_referral_tree(database.ADMIN_ID)
        if not tree_data:
            await update.message.reply_text("â„¹ï¸ Ù‡ÛŒÚ† Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø¹ÙˆØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.")
            return

        formatted_tree = database.format_referral_tree(tree_data)

        # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØµÙˆØ±Øª Ú©Ø¯ Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ ÙØ±Ù…Øª
        await update.message.reply_text(
            f"ğŸŒ³ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§:\n\n"
            f"<code>{formatted_tree}</code>",
            parse_mode="HTML"
        )

    except Exception as e:
        print(f"Ø®Ø·Ø§: {str(e)}")
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®Øª Ø¯Ø¹ÙˆØª")

==================================================
# ÙØ§ÛŒÙ„: handlers\file_handlers.py
==================================================

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from datetime import datetime
import database
import keyboards
from keyboards import get_qty_keyboard
import logging

logger = logging.getLogger(__name__)


async def handle_files(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    if not database.get_user(user.id):
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯!")
        return

    doc = update.message.document
    file_data = (
        user.id,
        doc.file_name,
        doc.mime_type,
        doc.file_id,
        doc.file_unique_id,
        datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        1,
        "ÙØ§Ù‚Ø¯ ØªÙˆØ¶ÛŒØ­Ø§Øª",
        "Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…",
        ""
    )

    if not database.add_file(file_data):
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„!")
        return

    # Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    keyboard = [
        [
            InlineKeyboardButton("ØªØ¹Ø¯Ø§Ø¯ ğŸ§®", callback_data="edit_qty")
        ],
        [
            InlineKeyboardButton("Ø§Ù†ØµØ±Ø§Ù âŒ", callback_data="cancel_file")
        ]
    ]

    await update.message.reply_document(
        document=doc.file_id,
        caption=f"""â° Ø²Ù…Ø§Ù† ØªØ­ÙˆÛŒÙ„: ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡
ğŸ§® ØªØ¹Ø¯Ø§Ø¯: 1
ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª: ÙØ§Ù‚Ø¯ ØªÙˆØ¶ÛŒØ­Ø§Øª
ğŸ“Œ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† ØªÙˆØ¶ÛŒØ­Ø§ØªØŒ Ø±ÙˆÛŒ Ù¾ÛŒØ§Ù… Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ú©Ù†ÛŒØ¯""",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    message = query.message

    try:
        logger.debug(f"Callback data received: {data}")

        # Ø¯Ø±ÛŒØ§ÙØª file_id Ø§Ø² Ù¾ÛŒØ§Ù… Ø§ØµÙ„ÛŒ
        if not message.document:
            logger.error("No document found in the message!")
            return

        file_id = message.document.file_id
        logger.info(f"Processing file ID: {file_id}")

        # Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†ÙˆØ§Ø¹ callback
        if data == "edit_qty":
            current_qty = database.get_file_quantity(file_id)
            await message.edit_reply_markup(
                reply_markup=keyboards.get_qty_keyboard(current_qty)
            )

        elif data in ("qty_up", "qty_down"):
            current_qty = int(message.reply_markup.inline_keyboard[0][1].text)

            if data == "qty_up":
                new_qty = current_qty + 1
            else:
                new_qty = max(1, current_qty - 1)

            # Ø¢Ù¾Ø¯ÛŒØª Ú©ÛŒØ¨ÙˆØ±Ø¯
            await message.edit_reply_markup(
                reply_markup=keyboards.get_qty_keyboard(new_qty)
            )

        elif data == "qty_confirm":
            final_qty = int(message.reply_markup.inline_keyboard[0][1].text)
            if database.update_file_quantity(file_id, final_qty):
                # Ø¢Ù¾Ø¯ÛŒØª Ú©Ù¾Ø´Ù†
                new_caption = message.caption.split('\n')
                new_caption[1] = f"ğŸ§® ØªØ¹Ø¯Ø§Ø¯: {final_qty}"
                await message.edit_caption(
                    caption="\n".join(new_caption),
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton("ØªØ¹Ø¯Ø§Ø¯ ğŸ§®", callback_data="edit_qty")],
                        [InlineKeyboardButton("Ø§Ù†ØµØ±Ø§Ù âŒ", callback_data="cancel_file")]
                    ])
                )
            else:
                await query.answer("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯!")

        elif data == "qty_cancel":
            await message.edit_reply_markup(
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("ØªØ¹Ø¯Ø§Ø¯ ğŸ§®", callback_data="edit_qty")],
                    [InlineKeyboardButton("Ø§Ù†ØµØ±Ø§Ù âŒ", callback_data="cancel_file")]
                ])
            )

        elif data == "cancel_file":
            await message.delete()
            database.delete_file(file_id)  # Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ø¨Ø¹ delete_file Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³

    except Exception as e:
        logger.error(f"Error in callback handler: {str(e)}", exc_info=True)
        await query.answer("âš ï¸ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø±Ø® Ø¯Ø§Ø¯!")


from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
import database

async def handle_reply(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø±ÛŒÙ¾Ù„Ø§ÛŒ Ø´Ø¯Ù‡"""
    if not update.message.reply_to_message.document:
        return

    user = update.effective_user
    file_id = update.message.reply_to_message.document.file_id
    description = update.message.text.strip()

    # Ø¢Ù¾Ø¯ÛŒØª ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    if database.update_file_description(file_id, description):
        # Ø¢Ù¾Ø¯ÛŒØª Ú©Ù¾Ø´Ù† Ù¾ÛŒØ§Ù…
        new_caption = f"""
â° Ø²Ù…Ø§Ù† ØªØ­ÙˆÛŒÙ„: ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡
ğŸ§® ØªØ¹Ø¯Ø§Ø¯: {database.get_file_quantity(file_id)}
ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª: {description}
        """.strip()

        keyboard = [
            [InlineKeyboardButton("ØªØ¹Ø¯Ø§Ø¯ ğŸ§®", callback_data="edit_qty")],
            [InlineKeyboardButton("Ø§Ù†ØµØ±Ø§Ù âŒ", callback_data="cancel_file")]
        ]

        await update.message.reply_to_message.edit_caption(
            caption=new_caption,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        await update.message.reply_text("âœ… ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!")
    else:
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙˆØ¶ÛŒØ­Ø§Øª!")


==================================================
# ÙØ§ÛŒÙ„: handlers\user_handlers.py
==================================================

from telegram import Update, ReplyKeyboardRemove, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler
from datetime import datetime
import database
from keyboards import customer_kb, admin_kb, wallet_kb, archive_reply_kb
from jdatetime import datetime as jdatetime
from database import get_customer_kb
import logging
import sqlite3
logger = logging.getLogger(__name__)

# ØªÙ†Ø¸ÛŒÙ… Ø³Ø·Ø­ Ù„Ø§Ú¯
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.DEBUG
)
ADMIN_ID = 2138687434
FULL_NAME, PHONE = range(2)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    args = context.args

    # Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª Ùˆ Ø¯Ø± Ø¬Ø¯ÙˆÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø«Ø¨Øª Ø´ÙˆØ¯
    if user.id == database.ADMIN_ID and not database.get_user(user.id):
        user_data = (
            user.id,
            "Ø§Ø¯Ù…ÛŒÙ†",  # Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø§Ø¯Ù…ÛŒÙ†
            "Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡",  # Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
            None,  # inviter_id Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† None Ø§Ø³Øª
            datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        )
        database.add_user(user_data)

    # Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§Ø´Ø¯
    if user.id == ADMIN_ID:
        await update.message.reply_text("ğŸ‘‘ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯!", reply_markup=admin_kb)
        return ConversationHandler.END

    # Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù‚Ø¨Ù„ÛŒ
    if database.get_user(user.id):
        await update.message.reply_text("âœ… Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!")
        return ConversationHandler.END

    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø¯ Ø±ÙØ±Ø§Ù„
    referral_code = None
    if args:
        for arg in args:
            if arg.startswith("ref_"):
                referral_code = arg[4:]
                break

    if not referral_code:
        await update.message.reply_text("ğŸ”’ Ø¯Ø³ØªØ±Ø³ÛŒ ÙÙ‚Ø· Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù…Ù…Ú©Ù† Ø§Ø³Øª!")
        return ConversationHandler.END

    context.user_data["referral_code"] = referral_code
    await update.message.reply_text("ğŸ‘¤ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return FULL_NAME



async def get_full_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["full_name"] = update.message.text
    await update.message.reply_text(
        "ğŸ“± Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ ğŸ“²", request_contact=True)]],
            resize_keyboard=True
        )
    )
    return PHONE


async def get_phone(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        # Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³
        if update.message.contact:
            phone = update.message.contact.phone_number
        else:
            phone = update.message.text.strip()
            if not phone.startswith('+'):
                phone = f"+98{phone[-10:]}"

        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø¯ Ø±ÙØ±Ø§Ù„
        referral_code = context.user_data.get("referral_code")
        valid, inviter_id = database.validate_referral(referral_code)
        if not valid:
            await update.message.reply_text(f"âŒ {inviter_id}")
            return ConversationHandler.END

        # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        user_data = (
            user.id,
            context.user_data["full_name"],
            phone,
            inviter_id,
            datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        )

        # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±
        if database.add_user(user_data):
            # Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø³ Ø§Ø² Ø«Ø¨Øª Ù…ÙˆÙÙ‚
            if inviter_id != database.ADMIN_ID:
                database.decrement_invites(inviter_id)
                database.add_discount(inviter_id, 50)
                database.add_invited_user(inviter_id, (
                    user.id,
                    context.user_data["full_name"],
                    phone,
                    datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                ))

            # Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ú©Ø¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡
            database.mark_referral_used(referral_code, user.id)

            await update.message.reply_text(
                "âœ… Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!",
                reply_markup=database.get_customer_kb(user.id)
            )
        else:
            await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±")

    except sqlite3.IntegrityError as e:
        await update.message.reply_text("âŒ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª!")
    except Exception as e:
        logging.exception("ğŸ”¥ Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…:")
        await update.message.reply_text("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ! Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ Ù…Ø¬Ø¯Ø¯ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
    finally:
        context.user_data.clear()
        return ConversationHandler.END


async def show_archive(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=archive_reply_kb
    )


async def handle_active_orders(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    active_orders = database.get_active_orders(user.id)

    if not active_orders:
        await update.message.reply_text("âœ… Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!")
        return

    response = "ğŸ“‹ Ø³ÙØ§Ø±Ø´Ø§Øª ÙØ¹Ø§Ù„ Ø´Ù…Ø§:\n\n"
    for order in active_orders:
        response += f"""ğŸ”– Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order[0]}
ğŸ“ ÙØ§ÛŒÙ„: {order[2]}
ğŸ§® ØªØ¹Ø¯Ø§Ø¯: {order[7]}
â³ ÙˆØ¶Ø¹ÛŒØª: {order[9]}
â–â–â–â–â–â–â–\n"""

    await update.message.reply_text(response)

async def cancel_registration(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù„ØºÙˆ ÙØ±Ø§ÛŒÙ†Ø¯ Ø«Ø¨Øª Ù†Ø§Ù…"""
    await update.message.reply_text(
        "âŒ Ø«Ø¨Øª Ù†Ø§Ù… Ù„ØºÙˆ Ø´Ø¯.",
        reply_markup=ReplyKeyboardRemove()
    )
    context.user_data.clear()
    return ConversationHandler.END


async def handle_archive(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    text = update.message.text

    days = None
    if text == "ğŸ•’ Ù‡ÙØªÙ‡ Ø§Ø®ÛŒØ±":
        days = 7
    elif text == "ğŸ“… Ù…Ø§Ù‡ Ø§Ø®ÛŒØ±":
        days = 30

    files = database.get_files_by_user(user.id, days)

    if not files:
        await update.message.reply_text(
            "âŒ Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!",
            reply_markup=customer_kb
        )
        return

    for file in files:
        miladi_date = datetime.strptime(file[6], "%Y-%m-%d %H:%M:%S")
        shamsi_date = jdatetime.fromgregorian(datetime=miladi_date)

        caption = f"""
ğŸ“ Ù†Ø§Ù… ÙØ§ÛŒÙ„: {file[2]}
ğŸ“… ØªØ§Ø±ÛŒØ® Ø§Ø±Ø³Ø§Ù„: 
  Ø´Ù…Ø³ÛŒ: {shamsi_date.strftime("%Y/%m/%d")}
  Ù…ÛŒÙ„Ø§Ø¯ÛŒ: {miladi_date.strftime("%Y/%m/%d")}
ğŸ§® ØªØ¹Ø¯Ø§Ø¯: {file[7]}
ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª: {file[8]}
        """.strip()

        await context.bot.send_document(
            chat_id=user.id,
            document=file[4],
            caption=caption
        )

    await update.message.reply_text(
        "âœ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù†Ø¯!",
        reply_markup=customer_kb
    )


async def generate_user_referral(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        logger.info(f"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {user.id}")

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        if not database.get_user(user.id):
            await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯!")
            return

        # Ø¯Ø±ÛŒØ§ÙØª ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
        remaining = database.get_remaining_invites(user.id)
        if remaining <= 0:
            await update.message.reply_text("âŒ Ø¸Ø±ÙÛŒØª Ø¯Ø¹ÙˆØª Ø´Ù…Ø§ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª!")
            return

        # ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø±ÙØ±Ø§Ù„ Ø¬Ø¯ÛŒØ¯
        code, error = database.create_referral(user.id, is_admin=False)
        if error:
            await update.message.reply_text(f"âŒ {error}")
            return

        # Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø¨Ø§ ÙØ±Ù…Øª ØµØ­ÛŒØ­
        bot = await context.bot.get_me()
        referral_link = f"https://t.me/{bot.username}?start=ref_{code}"

        # Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¨Ø§ ÙØ±Ù…Øª HTML Ø¨Ø±Ø§ÛŒ Ù‡Ø§ÛŒÙ¾Ø±Ù„ÛŒÙ†Ú©
        await update.message.reply_text(
            f"ğŸ‰ <b>Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù…Ø§:</b>\n"
            f"<a href='{referral_link}'>Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯Ø¹ÙˆØª</a>\n\n"
            f"ğŸ”¢ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØª Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: <b>{remaining}</b>\n"
            "âš ï¸ ØªÙˆØ¬Ù‡: Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø¨Ø§Ù„Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†Ø¯!",
            parse_mode="HTML",
            disable_web_page_preview=True
        )

        logger.info(f"Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user.id} ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯: {code}")

    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª: {str(e)}", exc_info=True)
        await update.message.reply_text("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ! Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")


async def handle_gift_request(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        logger.debug(f"Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ø¯ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user.id}")

        # Ù„Ø§Ú¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
        user_data = database.get_user(user.id)
        logger.debug(f"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±: {user_data}")

        # Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ·
        logger.debug("Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ· Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡")
        if database.meets_gift_conditions(user.id):
            logger.debug("Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ø§Ø³Øª")

            # Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¹ØªØ¨Ø§Ø±
            logger.debug("Ø¯Ø± Ø­Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¹ØªØ¨Ø§Ø±...")
            if database.add_discount(user.id, 100):
                logger.debug("Ø§Ø¹ØªØ¨Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯")
                await update.message.reply_text("ğŸ‰ 100 Ø¯Ù„Ø§Ø± Ø§Ø¹ØªØ¨Ø§Ø± Ù‡Ø¯ÛŒÙ‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯!")
            else:
                logger.error("Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¹ØªØ¨Ø§Ø±")
                await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹Ø·Ø§ÛŒ Ù‡Ø¯ÛŒÙ‡!")

        else:
            logger.debug("Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ù†ÛŒØ³Øª")
            await update.message.reply_text("âš ï¸ Ø´Ù…Ø§ Ø´Ø±Ø§ÛŒØ· Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø¯ÛŒÙ‡ Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.")

    except Exception as e:
        logger.exception(f"Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ: {str(e)}")
        await update.message.reply_text("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ! Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")


# user_handlers.py
async def show_direct_invites(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    try:
        invites = database.get_direct_invites(user.id)

        if not invites:
            await update.message.reply_text("â„¹ï¸ Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø±Ø§ Ø¯Ø¹ÙˆØª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!")
            return

        response = "ğŸ“‹ Ù„ÛŒØ³Øª Ù…Ø¯Ø¹ÙˆÛŒÙ† Ù…Ø³ØªÙ‚ÛŒÙ… Ø´Ù…Ø§:\n\n"
        for idx, (name, phone, date) in enumerate(invites, 1):
            response += f"{idx}. {name} - ğŸ“ {phone}\nğŸ•’ {date}\n\n"

        await update.message.reply_text(response)

    except Exception as e:
        logging.error(f"Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯Ø¹ÙˆÛŒÙ†: {str(e)}")
        await update.message.reply_text("âŒ Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ!")